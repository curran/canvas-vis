<!DOCTYPE html>

<html>
<head>
  <title>all.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>all.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>A <code>Component</code> renders to a Canvas, and responds to events.</p>
<ul>
<li><code>paint</code>: (ctx, bounds:<code>Rectangle</code>) -&gt;</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>define [<span class="string">'cv/expose'</span>], (expose) -&gt;
  Backbone.Model.extend
    initialize: -&gt; expose @, <span class="string">'paint'</span>
define [<span class="string">'cv/Component'</span>], (Component) -&gt;
  Backbone.Model.extend
    initialize: -&gt;
      <span class="property">@children</span> = <span class="keyword">new</span> Backbone.Collection
      <span class="property">@children</span>.<span class="literal">on</span> <span class="string">'add remove graphicsDirty'</span>, =&gt;
        <span class="property">@trigger</span> <span class="string">'graphicsDirty'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p><code>Point</code></p>
<ul>
<li><code>x</code>: Number</li>
<li><code>y</code>: Number</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>define [<span class="string">'cv/expose'</span>], (expose) -&gt;
  Backbone.Model.extend
    initialize: -&gt;
      expose @, <span class="string">'x'</span>, <span class="string">'y'</span>
      _.defaults @, {x:<span class="number">0</span>, y:<span class="number">0</span>}
    setXY: (<span class="property">@x</span>, <span class="property">@y</span>) -&gt;
define [<span class="string">'Rectangle'</span>], (Rectangle) -&gt;
  defaultBucketSize = <span class="number">50</span>
  
  <span class="function"><span class="title">insert</span></span> = (node, entry, bucketSize) -&gt;
    node.bounds.expandToFit entry.bounds
    <span class="keyword">if</span> node.isLeaf
      <span class="keyword">if</span> node.entries.length &lt; bucketSize
        node.entries.push entry
      <span class="keyword">else</span>
        split node, bucketSize
        insert node, entry, bucketSize
    <span class="keyword">else</span>
      insert (bestChild node, entry), entry, bucketSize

  <span class="function"><span class="title">split</span></span> = (node, bucketSize) -&gt;
    child1 = <span class="keyword">new</span> RNode; child2 = <span class="keyword">new</span> RNode
    xMin = _.min node.entries, (e) -&gt; e.bounds.x1
    xMax = _.max node.entries, (e) -&gt; e.bounds.x2
    yMin = _.min node.entries, (e) -&gt; e.bounds.y1
    yMax = _.max node.entries, (e) -&gt; e.bounds.y2
    horizontal = xMax.bounds.x2 - xMin.bounds.x1
    vertical = yMax.bounds.y2 - yMin.bounds.y1

    <span class="keyword">if</span>(vertical &gt; horizontal)
      min = zMin; max = xMax
    <span class="keyword">else</span>
      min = xMin; max = xMax

  <span class="class"><span class="keyword">class</span> <span class="title">RTree</span></span>
    constructor: (<span class="property">@bucketSize</span> = defaultBucketSize) -&gt;
      <span class="property">@root</span> = <span class="keyword">new</span> RNode
    insert: (item, bounds) -&gt;
      insert <span class="property">@root</span>, (<span class="keyword">new</span> Entry item, bounds), <span class="property">@bucketSize</span>

  <span class="function"><span class="title">RNode</span></span> = -&gt;
    <span class="property">@children</span> = []
    <span class="property">@bounds</span> = emptyBounds()
    <span class="property">@isLeaf</span> = <span class="literal">true</span>
    <span class="property">@entries</span> = []

  <span class="function"><span class="title">Entry</span></span> = (<span class="property">@item</span>, <span class="property">@bounds</span>) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>TODO transition to using constructors</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  create: (bucketSize = <span class="number">50</span>) -&gt;
    <span class="keyword">new</span> RTree bucketSize</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p><code>Rectangle</code></p>
<ul>
<li><code>position</code>: Point</li>
<li><code>size</code>: Dimension</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>define [<span class="string">'cv/expose'</span>], (expose) -&gt;
  Backbone.Model.extend
    initialize: -&gt;
      expose @, <span class="string">'x'</span>, <span class="string">'y'</span>, <span class="string">'w'</span>, <span class="string">'h'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Some ideas for defining relations (as in tables) using Backbone.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>define [], -&gt;

  Model = Backbone.Model
  Collection = Backbone.Collection

  Relation = Model.extend
    initialize: () -&gt;
      <span class="property">@columns</span> = <span class="keyword">new</span> Collection model: Column
      <span class="property">@rows</span> = <span class="keyword">new</span> Collection model: Row
    addColumn: (name) -&gt; <span class="property">@columns</span>.add <span class="keyword">new</span> Column {name}
    addRow:    (values) -&gt; <span class="property">@rows</span>.add  <span class="keyword">new</span> Row {values}
    computeMinMax: () -&gt; <span class="property">@columns</span>.each (column) =&gt;
      column.set
        min: <span class="property">@rows</span>.min (row) -&gt; row.values[column.index]
        max: <span class="property">@rows</span>.max (row) -&gt; row.values[column.index]

  Row = Model.extend()</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>use property <code>data</code> = an array of literal values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  Column = Model.extend()</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>use properties <code>name</code>, <code>min</code>, <code>max</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  r = <span class="keyword">new</span> Relation
  r.addColumn <span class="string">'Country'</span>
  r.addColumn <span class="string">'Year'</span>
  r.addColumn <span class="string">'Population'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Data crowdsourced from Amazon Mechanical Turk</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  r.addRow [<span class="string">'India'</span>,          <span class="number">1950</span>, <span class="number">369880000</span>]
  r.addRow [<span class="string">'China'</span>,          <span class="number">1950</span>, <span class="number">554760000</span>]
  r.addRow [<span class="string">'United States'</span>, <span class="number">1950</span>, <span class="number">150697361</span>]
  r.addRow [<span class="string">'India'</span>,         <span class="number">2010</span>, <span class="number">1150000000</span>]
  r.addRow [<span class="string">'China'</span>,         <span class="number">2010</span>, <span class="number">1339724852</span>]
  r.addRow [<span class="string">'United States'</span>, <span class="number">2010</span>, <span class="number">308745538</span>]
  r.computeMinMax()
   
  Relation.example = r

  <span class="keyword">return</span> Relation</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p><code>Viewport</code></p>
<ul>
<li><code>src</code>: Rectangle</li>
<li><code>dest</code>: Rectangle</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>define [<span class="string">'cv/expose'</span>], (expose) -&gt;
  Viewport = Backbone.Model.extend
    initialize: -&gt; expose @, <span class="string">'src'</span>, <span class="string">'dest'</span>
    srcToDest: (inPt, outPt) -&gt;
      s = <span class="property">@src</span>; d = <span class="property">@dest</span>
      outPt.x = (inPt.x - s.x) / s.w * d.w + d.x
      outPt.y = (inPt.y - s.y) / s.h * d.h + d.y
    destToSrc: (inPt, outPt) -&gt;
      s = <span class="property">@src</span>; d = <span class="property">@dest</span>
      outPt.x = (inPt.x - d.x) / d.w * s.w + s.x
      outPt.y = (inPt.y - d.y) / d.h * s.h + s.y
define [<span class="string">'cv/Container'</span>, <span class="string">'cv/Viewport'</span>, <span class="string">'cv/Rectangle'</span>]
     , (Container, Viewport, Rectangle) -&gt;
  <span class="function"><span class="title">add</span></span> = (superAdd, child) -&gt;
    <span class="keyword">if</span> <span class="keyword">not</span> child.getBoundingBox <span class="keyword">then</span> <span class="keyword">throw</span> Error <span class="string">"""
      ViewportContainer.add(child) expects 
      child.getBoundingBox, a Rectangle to be projected 
      from the viewport source bounds to the display 
      bounds before calling child.paint().
    """</span>
    superAdd child
  create: -&gt;
    container = viewport: Viewport.create()
    _.extend container, Container.create
      paint: (ctx, bounds) -&gt;
        <span class="property">@viewport</span>.dest = bounds
        <span class="property">@each</span> (child) =&gt;
          child.paint ctx, <span class="property">@viewport</span>.srcToDestRect child.bounds
    container.add = _.wrap container.add, add
    <span class="keyword">return</span> container
define [], -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p><code>match</code></p>
<p>This utility lets us approximate Haskell&#39;s 
pattern matching syntax in CoffeeScript</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="function"><span class="title">match</span></span> = (property, fns, fnName = <span class="string">'obj'</span>) -&gt;
    (obj) -&gt;
      fn = fns[obj[property]]
      <span class="keyword">if</span> fn</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>fn.apply is used ( instead of <code>fn(tree)</code>)
so matched functions can take many arguments.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        fn.apply <span class="literal">null</span>, arguments
      <span class="keyword">else</span>
        <span class="keyword">throw</span> Error <span class="string">"no match for <span class="subst">#{fnName}</span>.<span class="subst">#{property}</span> = <span class="subst">#{tree.type}</span>"</span>

  Model = Backbone.Model
  Collection = Backbone.Collection


  BufferedComponent = Component.extend
    initialize: -&gt;
      <span class="keyword">if</span> !<span class="property">@get</span> <span class="string">'component'</span>
        <span class="keyword">throw</span> Error <span class="string">""" BufferedComponent constructor
          expects a `component` property, which was not given """</span>
      (<span class="property">@get</span> <span class="string">'component'</span>).<span class="literal">on</span> <span class="string">'graphicsDirty'</span>, =&gt;
        <span class="property">@trigger</span> <span class="string">'graphicsDirty'</span>

  Container = Component.extend
    initialize: -&gt;
      <span class="keyword">if</span> !<span class="property">@get</span> <span class="string">'children'</span>
        <span class="property">@set</span> <span class="string">'children'</span>, <span class="keyword">new</span> Collection
      (<span class="property">@get</span> <span class="string">'children'</span>).<span class="literal">on</span> <span class="string">'graphicsDirty'</span>, =&gt;
        <span class="property">@trigger</span> <span class="string">'graphicsDirty'</span>

  LinearContainer = Component.extend()</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p><code>ViewportContainer</code></p>
<ul>
<li><code>viewport</code>:<code>Viewport</code></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  ViewportContainer = Component.extend()</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p><code>MarkSet</code></p>
<ul>
<li><code>relation</code>:<code>Relation</code></li>
<li><code>generator</code>: -&gt; (<code>Relation</code>) -&gt; MarkIterator</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  MarkSet = ViewportContainer.extend()</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p><code>MarkIterator</code></p>
<ul>
<li><code>hasNext</code>: -&gt; Boolean</li>
<li><code>next</code>: -&gt; Mark</li>
</ul>
<p><code>Relation</code></p>
<ul>
<li><code>tuples</code>: Collection&lt;<code>Tuple</code>&gt; - rows</li>
<li><code>attributes</code>: Collection&lt;<code>Attribute</code>&gt; - columns</li>
</ul>
<p>with rows (<code>tuples</code>) and columns (<code>attributes</code>).
The terms &quot;tuple&quot; and &quot;attribute&quot; are used because
they are the norm in literature on relational algebra.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  Relation = Model.extend
    initialize: () -&gt;
      <span class="property">@tuples</span> =    <span class="keyword">new</span> Collection model: Tuple
      <span class="property">@attributes</span> = <span class="keyword">new</span> Collection model: Attribute

    addAttribute: (name) -&gt; <span class="property">@attributes</span>.add <span class="keyword">new</span> Attribute {name}
    addTuple: (values) -&gt; <span class="property">@tuples</span>.add <span class="keyword">new</span> Tuple {values}
    computeMinMax: () -&gt; <span class="property">@attributes</span>.each (attribute) =&gt;
      i = attribute.index
      attribute.set
        min: <span class="property">@tuples</span>.min (tuple) -&gt; tuple.values[i]
        max: <span class="property">@tuples</span>.max (tuple) -&gt; tuple.values[i]</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p><code>Tuple</code></p>
<ul>
<li><code>values</code>: a JS Array of literal values (strings or numbers)</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  Tuple = Model.extend()</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p><code>Attribute</code></p>
<ul>
<li><code>name</code>: String</li>
<li><code>min</code>: Number</li>
<li><code>max</code>: String</li>
<li><code>index</code>: Integer - the tuple index of this attribute</li>
</ul>
<p>TODO move min/max computation our into a relational
algebra aggregation operator</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  Attribute = Model.extend()</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p><code>Viewport</code></p>
<ul>
<li><code>src</code>: Rectangle</li>
<li><code>dest</code>: Rectangle</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  Viewport = Model.extend
    srcToDestPoint: (srcPoint, outDestPoint) -&gt;
    srcToDestRect: (srcRect, outDestRect) -&gt;
    project: alias @ <span class="string">'srcToDestRect'</span>
    destToSrcPoint: (destPoint, outSrcPoint) -&gt;
    destToSrcRect: (destRect, outSrcRect) -&gt;

  <span class="function"><span class="title">alias</span></span> = (_<span class="keyword">this</span>, method) -&gt;
    -&gt; _<span class="keyword">this</span>[method].call arguments</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p><code>mark</code></p>
<p>A visual mark API that never creates new objects.</p>
<p>Example usage:</p>
<pre><code>code
code</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>   
  mark = (-&gt;
    <span class="function"><span class="title">mark</span></span> = -&gt;
      _.extend properties defaults
      <span class="keyword">return</span> singleton

    properties = {}

    defaults =
      bounds: <span class="keyword">new</span> Rectangle
      fillStyle: <span class="string">'black'</span>
      shape: <span class="string">'square'</span>
      rotation: <span class="number">0</span>

    singleton =</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Chainable property setter functions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      shape:     (   shape   ) -&gt; properties.shape = shape;            @
      fillStyle: (cssColorStr) -&gt; properties.fillStyle = cssColorStr;  @
      bounds:    (x, y, w, h ) -&gt; properties.bounds.setAll x, y, w, h; @
      position:  (   x, y    ) -&gt; properties.bounds.position.set x, y; @
      size:      (  w, h = w ) -&gt; properties.bounds.size.set w, h;     @
      x:         (     x     ) -&gt; properties.bounds.position.x = x;    @
      y:         (     y     ) -&gt; properties.bounds.position.y = y;    @
      w:         (     w     ) -&gt; properties.bounds.size.w = w;        @
      h:         (     h     ) -&gt; properties.bounds.size.h = h;        @
      rotation:  (  rotation ) -&gt; properties.rotation = rotation;      @</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Functions that evaluate the mark</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      getBounds: (             ) -&gt; shape().bounds()
      render:    (ctx, viewport) -&gt; shape().render(ctx, viewport)

    <span class="function"><span class="title">shape</span></span> = -&gt;
      <span class="keyword">if</span> !shapes[properties.shape]
        <span class="keyword">throw</span> Error <span class="string">"Unknown shape type '<span class="subst">#{properties.shape}</span>'"</span>
      shapes[properties.shape]

    shapes =
      square:
        bounds: -&gt; properties.bounds.clone()
        render: (ctx, viewport) -&gt;
          ctx.fillStyle = properties.fillStyle
          bounds = viewport.project properties.bounds
          ctx.fillRect(
            bounds.position.x,
            bounds.position.y,
            bounds.size.w,
            bounds.size.h
          )

    <span class="keyword">return</span> mark
  )()

  ScatterPlot = MarkSet.extend
    initialize: -&gt;
      expectProperties <span class="string">'xAttr'</span>, <span class="string">'yAttr'</span>
    generator: (relation) -&gt;
      tuples = relation.iterator()

      hasNext: -&gt; tuples.hasNext()
      next: -&gt;
        tuple = tuples.next()
        x = (<span class="property">@get</span> <span class="string">'xAttr'</span>).index
        y = (<span class="property">@get</span> <span class="string">'yAttr'</span>).index
        mark()
          .x    tuple[x]
          .y    tuple[y]

  <span class="function"><span class="title">expectProperties</span></span> = (_<span class="keyword">this</span>, properties...) -&gt;
    _.each properties, (property) -&gt;
      <span class="keyword">if</span> !_<span class="keyword">this</span>.get property
        <span class="keyword">throw</span> Error <span class="string">""" Missing expected property
          '<span class="subst">#{property}</span>' in constructor call."""</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p><code>bindToCanvas</code> causes a given <code>Component</code> to be rendered
on a given HTML5 Canvas element.</p>
<p>The component is re-rendered whenever it fires a &#39;graphicsDirty&#39; event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>define [<span class="string">'requestAnimFrame'</span>, <span class="string">'cv/Rectangle'</span>]
       ,(requestAnimFrame,      Rectangle) -&gt;
  (canvasId, component) -&gt;
    canvas = document.getElementById canvasId
    <span class="keyword">if</span> <span class="keyword">not</span> canvas <span class="keyword">then</span> <span class="keyword">throw</span> Error <span class="string">"Invalid Canvas ID: '<span class="subst">#{canvasId}</span>'"</span>

    ctx = canvas.getContext <span class="string">'2d'</span>

    bounds = <span class="keyword">new</span> Rectangle
      x: <span class="number">0</span>
      y: <span class="number">0</span>
      w: canvas.width
      h: canvas.height

    graphicsDirty = <span class="literal">true</span>
    component.<span class="literal">on</span> <span class="string">'graphicsDirty'</span>, -&gt; graphicsDirty = <span class="literal">true</span>

    executeFrame = () -&gt;
      <span class="keyword">if</span> graphicsDirty
        bounds.w = canvas.width
        bounds.h = canvas.height
        component.paint ctx, bounds
        graphicsDirty = <span class="literal">false</span>
      requestAnimFrame executeFrame

    executeFrame()</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>The <code>expose</code> module is a function that exposes properties of
Backbone models using JS setters and getters.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>define [], -&gt;
  (model, properties...) -&gt;
    <span class="keyword">if</span> !model <span class="keyword">then</span> <span class="keyword">throw</span> Error <span class="string">'model argument to `expose` is null!'</span>
    _.each properties, (p) -&gt;
      model.__defineGetter__ p, -&gt; model.get p
      model.__defineSetter__ p, (val) -&gt; model.set p, val</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
